name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Decrypt SSH key
      run: |
        echo "${{ secrets.EC2_KEY }}" > private_key.pem
        chmod 600 private_key.pem

    - name: Connect & Deploy on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        
        echo "ðŸ”„ Pulling latest code..."
        cd ~/churn_prediction
        git reset --hard
        git pull origin main

        echo "ðŸ³ Rebuilding Docker containers..."
        sudo docker compose down
        sudo docker compose build --no-cache
        sudo docker compose up -d

        echo "âœ” Deployment completed successfully!"
        EOF
